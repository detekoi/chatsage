[![English](https://img.shields.io/badge/lang-English-blue?style=flat)](../README.md)
[![Español (MX)](https://img.shields.io/badge/lang-Español%20(MX)-red?style=flat)](README-es-mx.md)
[![Português (BR)](https://img.shields.io/badge/lang-Português%20(BR)-green?style=flat)](README-pt-br.md)
[![Deutsch](https://img.shields.io/badge/lang-Deutsch-yellow?style=flat)](README-de.md)
[![Français](https://img.shields.io/badge/lang-Français-lightgrey?style=flat)](README-fr.md)
[![Italiano](https://img.shields.io/badge/lang-Italiano-orange?style=flat)](README-it.md)
[![日本語](https://img.shields.io/badge/lang-日本語-violet?style=flat)](README-ja.md)
[![Русский](https://img.shields.io/badge/lang-Русский-lightcoral?style=flat)](README-ru.md)

# ChatSage

ChatSage — это чат-бот на базе искусственного интеллекта, разработанный для чатов Twitch на любом языке. Он предоставляет контекстуально релевантные ответы на основе истории чата, запросов пользователей и информации о стриме в реальном времени (текущая игра, название, теги).

> Важно: доступ к ChatSage сейчас осуществляется только по приглашению через список разрешённых каналов (allow-list). Самостоятельная активация через веб‑панель отключена для неутверждённых каналов. Если вы хотите попробовать бота, пожалуйста, свяжитесь со мной здесь: [форма обратной связи](https://detekoi.github.io/#contact-me).

**[Добавить ChatSage на ваш канал Twitch →](https://streamsage-bot.web.app)**

[![License](https://img.shields.io/badge/License-BSD%202--Clause-blue.svg)](../LICENSE.md) 

## Содержание

- [Функции (Основные возможности)](#features-core-capabilities)
- [Добавление ChatSage на ваш канал](#adding-chatsage-to-your-channel)
- [Примеры использования](#usage-examples)
- [Предварительные требования для разработки](#development-prerequisites)
- [Начало работы](#getting-started)
- [Запуск бота](#running-the-bot)
- [Конфигурация](#configuration)
- [Управление токенами Twitch](#twitch-token-management)
- [Docker](#docker)

## Функции (Основные возможности)

*   Подключается к указанным каналам Twitch через IRC.
*   Получает контекст стрима в реальном времени (игра, название, теги, миниатюры изображений) с помощью Twitch Helix API.
*   Использует Google Gemini 2.0 Flash LLM для понимания естественного языка и генерации ответов.
*   Поддерживает контекст беседы (историю и сводки) для каждого канала.
*   Поддерживает пользовательские команды чата с уровнями разрешений.
*   Настраиваемые языковые параметры бота для поддержки многоязычных каналов.
*   Настраивается через переменные окружения.
*   Включает структурированное логирование, подходящее для производственных сред.
*   Веб-интерфейс управления каналами для стримеров для добавления/удаления бота.

## Добавление ChatSage на ваш канал

Примечание: Только заранее одобренные каналы из allow-list могут включать ChatSage. Если ваш канал пока не одобрен, но вы хотите попробовать бота, свяжитесь со мной через [форму обратной связи](https://detekoi.github.io/#contact-me).

Если ваш канал одобрен, вы можете добавить или удалить ChatSage через веб‑интерфейс:

1. **Посетите портал управления ChatSage**:
   - Перейдите на [Портал управления ChatSage](https://streamsage-bot.web.app) (только для одобренных каналов)
   - Нажмите "Войти через Twitch"

2. **Авторизуйте приложение**:
   - Вы будете перенаправлены на Twitch для авторизации ChatSage
   - Предоставьте необходимые разрешения
   - Этот процесс безопасен и использует OAuth-механизм Twitch

3. **Управление ботом**:
   - После входа в систему вы увидите свою панель управления
   - Используйте кнопку "Добавить бота на мой канал", чтобы ChatSage присоединился к вашему каналу
   - Используйте "Удалить бота с моего канала", если хотите его удалить

4. **Время присоединения бота**:
   - После добавления бота он должен присоединиться к вашему каналу в течение нескольких минут
   - Если бот не присоединяется в течение 10 минут, попробуйте удалить и добавить его снова
   - Важно: если бот не отвечает, предоставьте ему статус модератора командой `/mod ChatSageBot`

5. **Взаимодействие с пользователем**:
   - Зрители могут взаимодействовать с ChatSage, упоминая его: `@ChatSageBot привет` (имя пользователя будет обновлено, чтобы отразить новое имя, ChatSage, когда Twitch позволит мне это сделать)
   - Или используя различные [команды](https://detekoi.github.io/botcommands.html), такие как `!ask`, `!translate` и т.д.

## Примеры использования

### Команды чата

Полный список доступных команд и их использование см. в [Документации по командам бота](https://detekoi.github.io/botcommands.html).

## Предварительные требования для разработки

*   Node.js (рекомендуется версия 22.0.0 или новее)
*   npm (или yarn)

## Начало работы

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/detekoi/chatsage.git
    cd chatsage
    ```

2.  **Установите зависимости:**
    ```bash
    npm install
    ```
    *(Или `yarn install`, если вы предпочитаете Yarn)*

3.  **Настройте переменные окружения:**
    *   Скопируйте пример файла окружения:
        ```bash
        cp .env.example .env
        ```
    *   Отредактируйте файл `.env` и введите свои учетные данные и настройки. Обратитесь к комментариям в `.env.example` для получения подробной информации о каждой переменной (имя пользователя/токен бота Twitch, идентификатор клиента/секрет приложения Twitch, ключ API Gemini, каналы для подключения и т.д.). **Не добавляйте ваш файл `.env` в систему контроля версий.**

## Запуск бота

*   **Разработка:**
    Использует встроенный режим наблюдения Node для автоматического перезапуска при изменении файлов. По умолчанию включает удобочитаемые ("pretty") логи, если `PINO_PRETTY_LOGGING=true` в `.env`.
    ```bash
    npm run dev
    ```

*   **Продакшн:**
    Запускает бота с использованием стандартного `node`. Выводит структурированные JSON-логи, подходящие для систем агрегации логов.
    ```bash
    npm start
    ```

## Конфигурация

ChatSage настраивается в основном через переменные окружения. Обязательные и необязательные переменные задокументированы в файле `.env.example`. Ключевые переменные включают:

*   `TWITCH_BOT_USERNAME`: Имя пользователя для аккаунта Twitch бота.
*   `TWITCH_CHANNELS`: Список каналов для подключения через запятую. Используется в качестве запасного варианта, если управление каналами Firestore недоступно.
*   `TWITCH_CHANNELS_SECRET_NAME`: Имя ресурса для списка каналов в Google Secret Manager. Используется в качестве запасного варианта, если управление каналами Firestore недоступно.
*   `GEMINI_API_KEY`: Ваш ключ API для сервиса Google Gemini.
*   `TWITCH_CLIENT_ID`, `TWITCH_CLIENT_SECRET`: Учетные данные для вашего зарегистрированного приложения Twitch (используются для вызовов Helix API).
*   `TWITCH_BOT_REFRESH_TOKEN_SECRET_NAME`: Имя ресурса для токена обновления в Google Secret Manager.
*   `STREAM_INFO_FETCH_INTERVAL_SECONDS`: Как часто обновлять данные контекста стрима.
*   `LOG_LEVEL`: Контролирует подробность логов.

Убедитесь, что все необходимые переменные установлены в вашей среде или файле `.env` перед запуском бота.

## Управление токенами Twitch

ChatSage использует безопасный механизм обновления токенов для поддержания аутентификации с Twitch:

### Аутентификация бота в IRC

1.  **Предварительные условия для генерации токена**:
    * **Приложение Twitch**: Убедитесь, что вы зарегистрировали приложение в [консоли разработчика Twitch](https://dev.twitch.tv/console/). Запишите ваш **Client ID** и сгенерируйте **Client Secret**.
    * **URI перенаправления OAuth**: В настройках вашего приложения Twitch добавьте `http://localhost:3000` в качестве URL-адреса перенаправления OAuth. Twitch CLI по умолчанию использует этот URL в качестве первого URL-адреса перенаправления.
    * **Twitch CLI**: Установите [Twitch CLI](https://dev.twitch.tv/docs/cli/install) на ваш локальный компьютер.

2.  **Настройка Twitch CLI**:
    * Откройте терминал или командную строку.
    * Выполните `twitch configure`.
    * При появлении запроса введите **Client ID** и **Client Secret** из вашего приложения Twitch.

3.  **Генерация токена доступа пользователя и токена обновления с помощью Twitch CLI**:
    * Выполните следующую команду в терминале. Замените `<your_scopes>` списком необходимых для вашего бота разрешений, разделенных пробелами. Для ChatSage вам нужны как минимум `chat:read` и `chat:edit`.
        ```bash
        twitch token -u -s 'chat:read chat:edit'
        ```
        *(Вы можете добавить другие разрешения, если они нужны пользовательским командам вашего бота, например, `channel:manage:polls channel:read:subscriptions`)*
    * CLI выведет URL-адрес. Скопируйте этот URL-адрес и вставьте его в свой веб-браузер.
    * Войдите в Twitch, используя **аккаунт Twitch, который должен использовать бот**.
    * Авторизуйте ваше приложение для запрошенных разрешений.
    * После авторизации Twitch перенаправит ваш браузер на `http://localhost:3000`. CLI, который временно запускает локальный сервер, перехватит код авторизации и обменяет его на токены.
    * Затем CLI выведет `User Access Token`, `Refresh Token`, `Expires At` (для токена доступа) и предоставленные `Scopes`.

4.  **Безопасное хранение токена обновления**:
    * Из вывода Twitch CLI скопируйте **Refresh Token**. Это критически важный токен, необходимый вашему боту для долгосрочной аутентификации.
    * Храните этот токен обновления безопасно в Google Secret Manager.

5.  **Настройка Google Secret Manager**:
    * Создайте проект Google Cloud, если у вас его нет.
    * Включите API Secret Manager в вашем проекте.
    * Создайте новый секрет в Secret Manager для хранения только что полученного токена обновления Twitch.
    * Запишите **имя ресурса** этого секрета. Оно будет выглядеть так: `projects/YOUR_PROJECT_ID/secrets/YOUR_SECRET_NAME/versions/latest`.
    * Установите это полное имя ресурса в качестве значения переменной окружения `TWITCH_BOT_REFRESH_TOKEN_SECRET_NAME` в конфигурации вашего бота (например, в файле `.env` или переменных окружения Cloud Run).
    * Убедитесь, что сервисный аккаунт, запускающий ваше приложение ChatSage (локально через ADC или в Cloud Run), имеет IAM-роль "Secret Manager Secret Accessor" для этого секрета.

6.  **Процесс аутентификации в ChatSage**:
    * При запуске ChatSage (в частности, `ircAuthHelper.js`) будет использовать `TWITCH_BOT_REFRESH_TOKEN_SECRET_NAME` для получения сохраненного токена обновления из Google Secret Manager.
    * Затем он будет использовать этот токен обновления вместе с `TWITCH_CLIENT_ID` и `TWITCH_CLIENT_SECRET` вашего приложения для получения свежего, кратковременного токена доступа OAuth от Twitch.
    * Этот токен доступа используется для подключения к Twitch IRC.
    * Если токен доступа истекает или становится недействительным, бот будет использовать токен обновления для автоматического получения нового.
    * Если сам токен обновления становится недействительным (например, отозван Twitch, изменен пароль пользователя), приложение зарегистрирует критическую ошибку, и вам потребуется повторить процесс генерации токена (шаги 3-4), чтобы получить новый токен обновления.

### Веб-интерфейс управления каналами

[Веб-интерфейс](https://github.com/detekoi/chatsage-web-ui) использует отдельный процесс OAuth, чтобы позволить стримерам управлять ботом на своем канале:

1.  **Настройка Firebase Functions**:
    *   Веб-интерфейс создан с использованием Firebase Functions и Hosting.
    *   Он использует Twitch OAuth для аутентификации стримеров.
    *   Когда стример добавляет или удаляет бота, он обновляет коллекцию Firestore.
    *   Бот периодически проверяет эту коллекцию, чтобы определить, к каким каналам присоединяться или какие покидать.

2.  **Переменные окружения для веб-интерфейса**:
    *   `TWITCH_CLIENT_ID`: Идентификатор клиента приложения Twitch.
    *   `TWITCH_CLIENT_SECRET`: Секрет клиента приложения Twitch.
    *   `CALLBACK_URL`: URL-адрес обратного вызова OAuth (URL-адрес вашей развернутой функции).
    *   `FRONTEND_URL`: URL-адрес вашего веб-интерфейса.
    *   `JWT_SECRET_KEY`: Секрет для подписи токенов аутентификации.
    *   `SESSION_COOKIE_SECRET`: Секрет для сессионных cookie.

Такой подход обеспечивает лучшую безопасность за счет использования стандартных процессов OAuth и официальных инструментов, а также избегания хранения конфиденциальных токенов непосредственно в конфигурационных файлах, где это возможно. Он также дает стримерам контроль над добавлением или удалением бота со своего канала.

<details>
<summary><strong>EventSub для бессерверного развертывания (необязательно)</strong></summary>

Этот проект поддерживает EventSub от Twitch для обеспечения "масштабирования до нуля" в бессерверном развертывании на платформах, таких как Google Cloud Run. Это значительно сокращает расходы на хостинг, запуская бота только тогда, когда канал, на котором он находится, в прямом эфире.

### Обзор

- **Как это работает:** Бот подписывается на события `stream.online`. Когда стример выходит в эфир, Twitch отправляет веб-хук, который запускает экземпляр бота. Бот остается активным во время трансляции и масштабируется до нуля экземпляров, когда все отслеживаемые каналы офлайн.
- **Экономия средств:** Эта модель может значительно сократить расходы на хостинг.

### Требуемые переменные окружения

Чтобы включить эту функцию, установите следующие переменные в вашей среде развертывания (например, Cloud Run):

- `LAZY_CONNECT=true`: Включает логику масштабирования до нуля.
- `TWITCH_EVENTSUB_SECRET`: Длинная, случайная, секретная строка, которую вы создаете для защиты вашей конечной точки веб-хука.
- `PUBLIC_URL`: Общедоступный URL вашего развернутого сервиса (например, `https://your-service.a.run.app`).

### Процесс настройки

1.  **Развертывание с переменными EventSub:**
    Разверните ваше приложение с указанными выше переменными окружения. Для Cloud Run вы бы использовали `gcloud run deploy` с `--set-env-vars`.

2.  **Подписка на события:**
    После развертывания запустите скрипт управления, чтобы подписать все ваши каналы на событие `stream.online`.
    ```bash
    node scripts/manage-eventsub.js subscribe-all
    ```

3.  **Проверка подписок:**
    Вы можете проверить, что подписки были успешно созданы:
    ```bash
    node scripts/manage-eventsub.js list
    ```

Эта настройка гарантирует, что бот потребляет ресурсы только тогда, когда ему необходимо быть активным на канале в прямом эфире.

</details>

## Docker

Предоставлен `Dockerfile` для сборки образа контейнера приложения.

1.  **Сборка образа:**
    ```bash
    docker build -t chatsage:latest .
    ```

2.  **Запуск контейнера:**
    Вам необходимо передать переменные окружения в контейнер. Один из способов — использовать файл окружения:
    ```bash
    docker run --rm --env-file ./.env -it chatsage:latest
    ```
    *(Убедитесь, что ваш файл `.env` правильно заполнен)*